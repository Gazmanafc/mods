<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- This package was generated by SleePys Modification Maker at http://sleepycode.com -->
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>runic:TopicLockedMessage</id>
	<version>2.2</version>
	<file name="$sourcedir/LockTopic.php">
		<operation>
			<search position="replace"><![CDATA[// Locks a topic... either by way of a moderator or the topic starter.
function LockTopic()
{
	global $topic, $user_info, $sourcedir, $board, $smcFunc;

	// Just quit if there's no topic to lock.
	if (empty($topic))
		fatal_lang_error('not_a_topic', false);

	checkSession('get');

	// Get Subs-Post.php for sendNotifications.
	require_once($sourcedir . '/Subs-Post.php');

	// Find out who started the topic - in case User Topic Locking is enabled.
	$request = $smcFunc['db_query']('', '
		SELECT id_member_started, locked
		FROM {db_prefix}topics
		WHERE id_topic = {int:current_topic}
		LIMIT 1',
		array(
			'current_topic' => $topic,
		)
	);
	list ($starter, $locked) = $smcFunc['db_fetch_row']($request);
	$smcFunc['db_free_result']($request);

	// Can you lock topics here, mister?
	$user_lock = !allowedTo('lock_any');
	if ($user_lock && $starter == $user_info['id'])
		isAllowedTo('lock_own');
	else
		isAllowedTo('lock_any');

	// Locking with high privileges.
	if ($locked == '0' && !$user_lock)
		$locked = '1';
	// Locking with low privileges.
	elseif ($locked == '0')
		$locked = '2';
	// Unlocking - make sure you don't unlock what you can't.
	elseif ($locked == '2' || ($locked == '1' && !$user_lock))
		$locked = '0';
	// You cannot unlock this!
	else
		fatal_lang_error('locked_by_admin', 'user');

	// Actually lock the topic in the database with the new value.
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}topics
		SET locked = {int:locked}
		WHERE id_topic = {int:current_topic}',
		array(
			'current_topic' => $topic,
			'locked' => $locked,
		)
	);

	// If they are allowed a "moderator" permission, log it in the moderator log.
	if (!$user_lock)
		logAction($locked ? 'lock' : 'unlock', array('topic' => $topic, 'board' => $board));
	// Notify people that this topic has been locked?
	sendNotifications($topic, empty($locked) ? 'unlock' : 'lock');

	// Back to the topic!
	redirectexit('topic=' . $topic . '.' . $_REQUEST['start'] . (WIRELESS ? ';moderate' : ''));
}]]></search>
			<add><![CDATA[//Thanks again to my mod advisor, Eliana Tamerin.
// Lock a topic.  Give the moderator a chance to post a reason.
function LockTopic()
{
	global $txt, $board, $topic, $user_info, $context, $language, $scripturl, $settings, $smcFunc, $modSettings;

	// Just quit if there's no topic to lock.
	if (empty($topic))
		fatal_lang_error('not_a_topic', false);

	// Find out who started the topic - in case User Topic Locking is enabled.
	$request = $smcFunc['db_query']('', '
		SELECT id_member_started, locked
		FROM {db_prefix}topics
		WHERE id_topic = {int:current_topic}
		LIMIT 1',
		array(
			'current_topic' => $topic,
		)
	);
	list ($starter, $locked) = $smcFunc['db_fetch_row']($request);
	$smcFunc['db_free_result']($request);

	// Can you lock topics here, mister?
	$user_lock = !allowedTo('lock_any');
	if ($user_lock && $starter == $user_info['id'])
		isAllowedTo('lock_own');
	else
		isAllowedTo('lock_any');

	// Locking with high privileges.
	if ($locked == '0' && !$user_lock)
		$context['locked'] = '1';
	// Locking with low privileges.
	elseif ($locked == '0')
		$context['locked'] = '2';
	// Unlocking - make sure you don't unlock what you can't.
	elseif ($locked == '2' || ($locked == '1' && !$user_lock))
		$context['locked'] = '0';
	// You cannot unlock this!
	else
		fatal_lang_error('locked_by_admin', 'user');

	loadTemplate('LockTopic');

	$context['page_title'] = !empty($context['locked']) ? $txt['set_lock'] : $txt['set_unlock'];

	// Register this form and get a sequence number in $context.
	checkSubmitOnce('register');
}

// Locks a topic... either by way of a moderator or the topic starter.
function LockTopic2()
{
	global $txt, $board, $topic, $scripturl, $sourcedir, $modSettings, $context;
	global $board, $language, $user_info, $smcFunc;

	// Just quit if there's no topic to lock.
	if (empty($topic))
		fatal_lang_error('not_a_topic', false);

	// Make sure this form hasn't been submitted before.
	checkSubmitOnce('check');

	checkSession();

	// Get Subs-Post.php for sendNotifications.
	require_once($sourcedir . '/Subs-Post.php');

	// Find out who started the topic - in case User Topic Locking is enabled.
	$request = $smcFunc['db_query']('', '
		SELECT t.id_member_started, t.locked, t.id_board, m.subject, t.id_first_msg
		FROM {db_prefix}topics as t
			LEFT JOIN {db_prefix}messages AS m ON (t.id_first_msg = m.id_msg)
		WHERE t.id_topic = {int:current_topic}
		LIMIT 1',
		array(
			'current_topic' => $topic,
		)
	);
	list ($starter, $locked, $board_id, $subject) = $smcFunc['db_fetch_row']($request);
	$smcFunc['db_free_result']($request);

	// Can you lock topics here, mister?
	$user_lock = !allowedTo('lock_any');
	if ($user_lock && $starter == $user_info['id'])
		isAllowedTo('lock_own');
	else
		isAllowedTo('lock_any');

	// Locking with high privileges.
	if ($locked == '0' && !$user_lock)
		$locked = '1';
	// Locking with low privileges.
	elseif ($locked == '0')
		$locked = '2';
	// Unlocking - make sure you don't unlock what you can't.
	elseif ($locked == '2' || ($locked == '1' && !$user_lock))
		$locked = '0';
	// You cannot unlock this!
	else
		fatal_lang_error('locked_by_admin', 'user');

	// Actually lock the topic in the database with the new value.
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}topics
		SET locked = {int:locked}
		WHERE id_topic = {int:current_topic}',
		array(
			'current_topic' => $topic,
			'locked' => $locked,
		)
	);

	// If they are allowed a "moderator" permission, log it in the moderator log.
	if (!$user_lock)
		logAction('lock', array('topic' => $topic, 'board' => $board));
	// Notify people that this topic has been locked?
	sendNotifications($topic, empty($locked) ? 'unlock' : 'lock');

	//Thanks Ryan Wagoner aka rsw686.
	//Old topic locked messages are not topic locked messages from this time.
	if(!empty($locked)) {
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}messages
			SET topicLockedMessage = 0
			WHERE id_topic = {int:current_topic} AND topicLockedMessage = 1',
			array(
				'current_topic' => $topic,
			)
		);
	}

	//Are we going to post a reason?
	if(isset($_POST['postLock']) && !empty($locked)) {

		$_POST['reason'] = $smcFunc['htmlspecialchars']($_POST['reason'], ENT_QUOTES);
		preparsecode($_POST['reason']);

		$msgOptions = array(
			'subject' => addslashes($txt['response_prefix'] . $subject),
			'body' => addslashes($_POST['reason']),
			'smileys_enabled' => 1,
			'topic_lock_message' => true,
		);
		$topicOptions = array(
			'id' => $topic,
			'board' => $board_id,
			'lock_mode' => null,
			'mark_as_read' => false,
		);
		$posterOptions = array(
			'id' => $user_info['id'],
			'update_post_count' => !empty($pcounter),
		);

		createPost($msgOptions, $topicOptions, $posterOptions);
	}
	
	//We are unlocking. Delete the locked message?
	if(isset($_POST['postLockerease']) && $locked == '0') {

		$request = $smcFunc['db_query']('', '
			SELECT id_msg
			FROM {db_prefix}messages
			WHERE id_topic = {int:current_topic} AND topicLockedMessage = 1
			ORDER BY id_msg DESC
			LIMIT 1',
			array(
				'current_topic' => $topic,
			)
		);

		list ($topic_locked_message) = $smcFunc['db_fetch_row']($request);
		$smcFunc['db_free_result']($request);

		// Get RemoveTopic.php for deleting.
		require_once($sourcedir . '/RemoveTopic.php');
		
		if(!empty($topic_locked_message))
			removeMessage($topic_locked_message, true);
	}

	// Back to the topic!
	redirectexit('topic=' . $topic . '.' . $_POST['start'] . (WIRELESS ? ';moderate' : ''));
}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Who.php">
		<operation>
			<search position="replace" whitespace="loose"><![CDATA[		'mods' => array(]]></search>
			<add><![CDATA[		'mods' => array( $txt['tlcopy'],]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="before"><![CDATA['icon' => 'string-16', 'approved' => 'int',]]></search>
			<add><![CDATA[ 'topicLockedMessage' => 'int',]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[$msgOptions['icon'], $msgOptions['approved'],]]></search>
			<add><![CDATA[ (!empty($msgOptions['topic_lock_message']) ? '1' : '0'),]]></add>
		</operation>
	</file>
	<file name="$boarddir/index.php">
		<operation>
			<search position="before"><![CDATA['lock' => array('LockTopic.php', 'LockTopic'),]]></search>
			<add><![CDATA[
		'lock2' => array('LockTopic.php', 'LockTopic2'),]]></add>
		</operation>
	</file>
</modification>